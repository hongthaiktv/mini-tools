#!/data/data/com.termux/files/usr/bin/bash

source /data/data/com.termux/files/home/bin/tmenu.sh

WDIR="$(pwd)"
ESC_KEY=$'\033'

if [[ ! -z "$1" ]]; then
	while IFS= read -r line; do
		if [[ -z "$TCMD_DST" ]]; then
			TCMD_DST="$line"
		else TCMD_SRC="$line"
		fi
	done < "$1"
	unset IFS
	echo "$(date +"%x %X") :: $TCMD_SRC" >> ~/.tfe_history
fi

action.dir() {
	echo "Directory Action"
	echo "----------------"
	echo

	if [[ -z "$DST" ]]; then
		local actions=( "Copy to TCMD" "Copy" "Delete" "Git" "Zip" "Zip to TCMD" "Detail" )
	else
		local prevDST="$(basename "$DST")"
		local actions=( "Copy to TCMD" "Copy" "Copy to \"$prevDST\"" "Delete" "Git" "Zip" "Zip to TCMD" "Detail" )
	fi

	tmenu "${actions[@]}"

	case "$TMENU_RESULT" in
		"Copy to TCMD")
			if [[ -z "$TCMD_DST" ]]; then
				read -rep "Destination: " TCMD_DST
				echo
				eval TCMD_DST="$TCMD_DST"
			fi
			cp -rf "$1" "$TCMD_DST"
			if [[ "$?" != 0 ]]; then
				echo
				read -rsn1 -p "Press any key to continue..." key
			fi
			;;

		"Copy")
			tmenu.fileExplorer "slDst"
			if [[ "$TMENU_RESULT" == "$ESC_KEY" ]]; then
				read -rep "Destination: " DST
				echo
				eval DST="$DST"
			fi
			cp -rf "$1" "$DST"
			if [[ "$?" != 0 ]]; then
				echo
				read -rsn1 -p "Press any key to continue..." key
			fi
			;;

		"Copy to \"$prevDST\"")
			cp -rf "$1" "$DST"
			if [[ "$?" != 0 ]]; then
				echo
				read -rsn1 -p "Press any key to continue..." key
			fi
			;;

		"Delete")
			local msg=""
			local dotOpt=""

			if [[ "$1" == "." ]]; then
				msg="Delete **All**? (y/N): "
			else msg="Delete \"$1\"? (y/N): "
			fi

			read -rn1 -p "$msg" key
			echo
			echo

			if [[ "$key" == "y" || "$key" == "Y" ]]; then
				if [[ "$1" == "." ]]; then
          			dotOpt=$(shopt -p dotglob)
          			dotOpt=${dotOpt:7:1}
					if [[ "$dotOpt" == "u" ]]; then
						shopt -s dotglob
						rm -rf *
					else rm -rf *
					fi
				else rm -rf "$1"
				fi

				if [[ "$?" != 0 ]]; then
					echo
					read -rsn1 -p "Press any key to continue..." key
				else unset prevItem
				fi

				if [[ "$dotOpt" == "u" ]]; then
					shopt -u dotglob
				fi
			fi
			;;

		"Git")
			local cMsg=""
			cd "$1"
			read -rn1 -p "(p)ull/(P)ush? " key
			echo

			if [[ -z "$key" || "$key" == "P" ]]; then
				read -rep "Message: " cMsg
				echo
				git add .
				git commit -m "$cMsg"
				git push
				echo
				read -rsn1 -p "Press any key to continue..." key
			elif [[ "$key" == "p" ]]; then
				echo
				git pull
				echo
				read -rsn1 -p "Press any key to continue..." key
			fi

			cd "$WDIR"
			;;

		"Zip")
			local zDst
			read -rep "Archive name: " zDst
			eval zDst="$zDst"
			7zz a -snl "$zDst" "$1"
			echo
			read -rsn1 -p "Press any key to continue..." key
			;;

		"Zip to TCMD")
			local zDst
			if [[ -z "$TCMD_DST" ]]; then
				read -rep "Directory Path: " TCMD_DST
			fi
			read -rep "Archive name: " zDst
			eval zDst="$TCMD_DST$zDst"
			7zz a -snl "$zDst" "$1"
			echo
			read -rsn1 -p "Press any key to continue..." key
			;;

		"Detail")
			echo "Directory Detail"
			echo "----------------"
			echo
			echo "Size: $(du -sh "$1")"
			echo
			ls -lh "$1"
			echo
			read -rsn1 -p "Press any key to continue..." key
			;;
	esac
}

action.file() {
	echo "File Action"
	echo "-----------"
	echo

	if [[ -z "$DST" ]]; then
		local actions=( "Copy to TCMD" "Copy" "Delete" "Edit" )
	else
		local prevDST="$(basename "$DST")"
		local actions=( "Copy to TCMD" "Copy" "Copy to \"$prevDST\"" "Delete" "Edit" )
	fi

	if [[ "$1" == *.zip || "$1" == *.7z || "$1" == *.gz || "$1" == *.xz || "$1" == *.tar || "$1" == *.rar ]]; then
		actions=( "${actions[@]}" "Extract" )
	fi

	tmenu "${actions[@]}"

	case "$TMENU_RESULT" in
		"Copy to TCMD")
			if [[ -z "$TCMD_DST" ]]; then
				read -rep "Destination: " TCMD_DST
				echo
				eval TCMD_DST="$TCMD_DST"
			fi
			cp -f "$1" "$TCMD_DST"
			if [[ "$?" != 0 ]]; then
				echo
				read -rsn1 -p "Press any key to continue..." key
			fi
			;;

		"Copy")
			local cDST=""
			tmenu.fileExplorer "slDst"
			if [[ "$TMENU_RESULT" == "$ESC_KEY" ]]; then
				read -rep "Destination: " cDST
				echo
				eval cDST="$cDST"
				cp -f "$1" "$cDST"
			else
				cp -f "$1" "$DST"
			fi

			if [[ "$?" != 0 ]]; then
				echo
				read -rsn1 -p "Press any key to continue..." key
			fi
			;;

		"Copy to \"$prevDST\"")
			cp -f "$1" "$DST"
			if [[ "$?" != 0 ]]; then
				echo
				read -rsn1 -p "Press any key to continue..." key
			fi
			;;

		"Delete")
			local msg="Delete \"$1\"? (y/N): "
			read -rn1 -p "$msg" key
			echo
			echo

			if [[ "$key" == "y" || "$key" == "Y" ]]; then
				rm -f "$1"
				if [[ "$?" != 0 ]]; then
					echo
					read -rsn1 -p "Press any key to continue..." key
				else unset prevItem
				fi
			fi
			;;

		"Edit")
			vim "$1"
			;;

		"Extract")
			local zDst
			read -rep "Destination: " zDst
			eval zDst="$zDst"
			7zz x -o"$zDst" "$1"
			echo
			read -rsn1 -p "Press any key to continue..." key
			;;
	esac
}

tmenu.fileExplorer() {
	SRC="$(pwd)"
	local title=""
	local prevItem=""

	while :; do
		local file_list=( "." ".." )
		local counter=1
		local checkPrev=0

		if [[ -z "$1" ]]; then
			title="File explorer\n-------------\n\n$(pwd)\n(0: Action | 1: Directory)\n"
		elif [[ "$1" == "slDst" ]]; then
			title="Select Destination\n------------------\n\n$(pwd)\n(0: Select)\n"
		fi

		for file in *; do
			(( ++counter ))
			file_list[$counter]="$file"
			if [[ "$prevItem" == "$file" ]]; then
				checkPrev=1
			fi
		done

		clear
		echo -e "$title"

		if [[ -z "$prevItem" || ! -z "$prevItem" && $checkPrev == 0 ]]; then
			prevItem=${file_list[2]}
		fi
		
		tmenu "$prevItem" "${file_list[@]}"
		
		prevItem="$MENU_SELECTED"

		if [[ "$TMENU_RESULT" == "$ESC_KEY" ]]; then
			break
		elif [[ "$TMENU_RESULT" == 0 ]]; then
			if [[ "$1" == "slDst" ]]; then
				DST="$(pwd)"
				TMENU_RESULT="$(pwd)"
				break
			elif [[ -d "$MENU_SELECTED" ]]; then
				action.dir "$MENU_SELECTED"
			elif [[ -f "$MENU_SELECTED" ]]; then
				action.file "$MENU_SELECTED"
			fi
		elif [[ "$TMENU_RESULT" == "." ]]; then
			action.dir "$TMENU_RESULT"
		elif [[ -d "$TMENU_RESULT" ]]; then
			cd "$TMENU_RESULT" 
			WDIR="$(pwd)"
			if [[ -z "$1" ]]; then
				SRC="$(pwd)"
			fi
			unset prevItem
		elif [[ -f "$TMENU_RESULT" ]]; then
			action.file "$TMENU_RESULT"
		fi
	done
	if [[ "$1" == "slDst" ]]; then
		cd "$SRC"
	fi
}

while :; do
	clear
	echo "           ##############################           "
	echo "           #                            #           "
	echo "           #     TERMUX FILE EDITOR     #           "
	echo "           #                            #           "
	echo "           ##############################           "
	echo

	tmenu "1. File explorer" "2. HASH check" "3. Backup document" "4. Vim" "5. History" "6. Exit"

	case "$TMENU_RESULT" in
		"1. File explorer") tmenu.fileExplorer ;;

		"2. HASH check")
			if [[ -z "$TCMD_SRC" ]]; then
				read -rep "File path: " TCMD_SRC
				eval TCMD_SRC="$TCMD_SRC"
			fi

			while :; do
				clear
				echo "HASH check"
				echo "----------"
				echo
				tmenu "1. SHA1" "2. SHA256" "3. SHA384" "4. SHA512" "5. MD5" "6. Back"

				case "$TMENU_RESULT" in
					"1. SHA1")
						echo === SHA1 ===
						sha1sum "$TCMD_SRC"
						echo
						read -rsn1 -p "Press ESC to exit, other keys to continue..." key
						echo
						echo
						if [[ "$key" == "$ESC_KEY" ]]; then
							exit
						fi
						;;

					"2. SHA256")
						echo === SHA256 ===
						sha256sum "$TCMD_SRC"
						echo
						read -rsn1 -p "Press ESC to exit, other keys to continue..." key
						echo
						echo
						if [[ "$key" == "$ESC_KEY" ]]; then
							exit
						fi
						;;
					
					"3. SHA384")
						echo === SHA384 ===
						sha384sum "$TCMD_SRC"
						echo
						read -rsn1 -p "Press ESC to exit, other keys to continue..." key
						echo
						echo
						if [[ "$key" == "$ESC_KEY" ]]; then
							exit
						fi
						;;
					
					"4. SHA512")
						echo === SHA512 ===
						sha512sum "$TCMD_SRC"
						echo
						read -rsn1 -p "Press ESC to exit, other keys to continue..." key
						echo
						echo
						if [[ "$key" == "$ESC_KEY" ]]; then
							exit
						fi
						;;
					
					"5. MD5")
						echo === MD5 ===
						md5sum "$TCMD_SRC"
						echo
						read -rsn1 -p "Press ESC to exit, other keys to continue..." key
						echo
						echo
						if [[ "$key" == "$ESC_KEY" ]]; then
							exit
						fi
						;;

					"6. Back" | "$ESC_KEY")
						unset TMENU_RESULT
						break
						;;

					"0" | "$ESC_KEY")
						unset TMENU_RESULT
						break
						;;
				esac
			done
			;;

		"3. Backup document")
			cd ~/docs
			git add .
			git commit -m "update"
			git push
			cd $WDIR
			echo
			read -rsn1 -p "Press ESC to exit, other keys to continue..." key
			echo
			echo
			if [[ "$key" == "$ESC_KEY" ]]; then
				exit
			fi
			;;

		"4. Vim") vim ;;

		"5. History")
			cat ~/.tfe_history
			echo
			read -rsn1 -p "Press any key to continue..." key
			;;

		"6. Exit" | "0" | "$ESC_KEY") exit ;;
	esac
done

